#summary Probe switch operations

= Introduction =

HeeksCNC supports the generation of GCode suitable for both edge and centre-point detection via a touch probe.  In the case of edge detection routines, the generated GCode includes a feature whereby the GCode stores the probed point locations into an XML file.  This XML file may be read into a Fixture object so that the edge's rotation from its nearest axis can be determined.

The suite of GCode routines available include;
 - Move to the centre of a protrusion by probing from the 'outside-inwards' at either two or four locations.  (See http://www.youtube.com/watch?v=2Wk4H_XmIek )

 - Move to the centre of a hole by probing from the 'inside-outwards' at either two or four locations. (See http://www.youtube.com/watch?v=7BEpL-wE0O8 )

 - Measure the rotation of an axis by measuring a single edge via two probed points.  This edge may be top, bottom, left or right.  The GCode program will generate an XML file describing the probed point locations.  This XML file may be read in to a Fixture object so as to set the fixture's rotation.  This ensures that subsequently generated GCode will align with the probed edge.

 - Move to the corner of two probed edges.  This operation probes two perpendicular edges based on one of the four corner designations.  The probed points will be stored in an XML file that may be read into a Fixture object so as to set its rotation attributes.  When finished, the machine's position will be left immediately above the intersection of the two probed edges.  (See http://www.youtube.com/watch?v=NwRYEo5YtCc )

 - Measure the XZ and YZ plane rotations (tilt) by probing three points.  The results of this operation, if performed using EMC2, can be read into a Fixture object to set the plane rotation values.

 - Obtain a point cloud from a square grid of points.


= Details =

== Move to centre of a protrusion (probe from the outside-in) ==

Before executing the GCode, the machine operator should jog the machine to the approximate location immediately above the protrusion to be probed.  The machine will move both out and down before probing back towards the original XY location.  This will be repeated in two opposing directions.  When finished, the machine's location will be at the original Z height but at the centre X,Y location of the two probed points.  This process will be repeated at the remaining two locations if the 'Number of Points' value is set to 'Four'.

== Move to the centre of a hole (probe from inside-out) ==

Before executing the GCode, the machine operator should jog the machine to the approximate location immediately above the hole to be probed.  The machine will move down before probing outwards in either two or four directions.  When completed, the machine will be returned to the original Z height but at the centre X,Y location of the probed points.  This function may be used for finding the centre of either a circular or rectangular hole.

== Move to the corner of two edges ==

Before executing the GCode, the machine operator should jog the machine to the approximate location immediately above the chosen corner of the workpiece.  NOTE: The selection of which corner MUST have been chosen within the probing operation's parameters.  The machine will move out, back and down before probing into an edge.  It will return to the original position between each probing operation.

When both edges have been probed, the machine's position will be returned to the original Z height but at the X,Y intersection of the two probed edges.

As with the other edge probing operation, this option writes the probed point locations into an XML file.  This XML file may be copied back from the machine's computer to that used for HeeksCNC.  The edge's rotation from its nearest axis can be set by reading the XML file into a Fixture object.

== Measure an edge's rotation ==

Before executing the GCode, the machine operator should jog the machine to the approximate location immediately above the work piece's edge.  The machine then moves out, back and down before probing back towards the workpiece's edge.  NOTE: The machine will return to the original location between each of the two probing operations.

When complete, the GCode will generate an XML file with the probed point locations stored within it.  This XML file may be imported into a Fixture object so as to set the workpiece's rotation from its nearest axis.

The machine's position will be returned to the originally jogged position upon completion of the GCode program.

== Measure the XZ and YZ plane rotations (tilt) ==

Before executing the GCode, the machine operator should jog the machine to the approximate location above the work surface at a nominal 0,0 coordinate.   The machine moves straight down (depth) to probe this first point.  It then repeats this probe at 'distance' in both the X and Y directions to obtain three probed point locations all together.  If the machine is controlled via EMC2, an XML log file will have been created with the coordinates of these three points.  This XML file may be read into a Fixture object so as to set the XZ and YZ plane rotation values for this fixture.  Once this is done, subsequently generated GCode will be rotated accordingly so as to align with the fixture.

== Obtain a point cloud ==

It should be noted that the algorithm for obtaining these probed points will not be very efficient.  Having said that, it does provide the ability to generate the GCode necessary to probe a square grid of points.  If the machine is run by EMC2, an XML file will have been generated with the coordinates of all probed points included.

== Calibrating the probe ==

By drilling a hole and measuring its centre position, we can measure any constant offsets imposed by the probe's physical geometry.  These offsets may be read into the touch probe's definition (within the 'Tools' list) for use in subsequent probing operations.

=== Procedure ===

1. Touch off to set the current physical machine position as (0,0,0).

2. Drill a hole.

3. Replace the drill bit with the touch probe.

4. Load and run a centre-finding operation (using 4 points).  This centre point will be 
stored in an XML file (for EMC2-based machines only).  This coordinate represents how far away from the 0,0 point the probe is.

5. Open up HeeksCNC.

6. Select the touch probe tool from within the 'Tools' list.

7. Use the right mouse button to select the 'Import probe calibration data' option.

8. Navigate and open the XML file generated during the previous probing operation.

9. Save the file.  Optionally, you may want to use the 'Export' function for the 'Tools' so that these calibration values can be written to the default.tooltable for future use.


Once the calibration data exists within the  touch probe definition, these offsets will be used in subsequent probing operations to allow for the probe's geometry.

== Parameters ==

=== Depth ===

When the programs begin, they assume that the machine operator has jogged the machine to a position nearby (and above) to where is necessary.  (see above for operator setup of each probing operation).  Whenever a rapid movement occurs between locations it will be at this initial Z height.  When a probing operation is necessary, the machine will plunge down by this 'depth' parameter's value before probing.  This value is relative to the manually jogged height.  i.e. it is a positive value representing a distance to plunge down before probing.

=== Distance ===

For a centre-finding probe operation, this distance describes how far the operation will move from the manually jogged location.  In the case of an outside-inwards operation, this distance is used for the initial rapid movement.  In the case of an inside-outwards operation, it represents the maximum distance of the probing operation from the jogged location.

In the case of an edge probing operation, it represents the distance both from the initial jogged position to the first probing operation as well as from the first probed point's location to the second probed point's location.

=== Probe Direction ===

For a centre-finding operation, this value is either *Inside* (representing a probe moving from the inside in an outwards direction) or *Outside* (representing a probe moving from outside a protrusion towards the centre)

This value is only relevant for centre finding probe operations.

=== Number of Points ===

For a centre-finding operation, this value may be either 'Two' or 'Four' representing whether an east/west centre is required or an north/south/east/west centre is required.

This value is only relevant for centre finding probe operations.

=== Retract ===

For edge (and corner) finding operations, this is the distance 'back' from the workpiece that the machine will rapidly move to before plunging down and probing towards the workpiece.  This is a distance that is relative to the originally jogged location (which should be immediately above the edge).  i.e. it is always a positive number that will be used when 'backing off' from the edge before a probing operation.  In this case, the probing operation will search for the edge over a distance defined as twice this retraction distance.

This value is only relevant for edge or corner finding probe operations.

=== Number of Edges ===
 
For edge (and corner) finding operations, this value may be either 'One' or 'Two'.

=== Edge ===

If the number of edges parameter is set to 'One' then the edge parameter becomes relevant.  The values available are; 'Top', 'Bottom', 'Left' and 'Right'.

=== Corner ===

If the number of edges parameter is set to 'Two' then the corner parameter becomes relevant.  The values available are; 'BottomLeft', 'BottomRight', 'TopLeft' and 'TopRight'.


=== Alignment ===

For two point centre finding probe operations, this alignment setting determines if we're looking to find the centre along the X axis or the Y axis.  It is only relevant if the number of points is set to two.

=== Check Levels ===

If this is 'True' then an extra probing operation will occur at each of an edge (or corner) probed point.  This extra probe is to find the Z coordinate at the probed point's location.  The intent is to support the import of enough information to ascertain the part's rotation in all of the XY, XZ and YZ planes.  NOTE that, although the fixture rotations can be set for the XZ and YZ planes as well, many of the GCode generation routines only support rotation in the XY plane. 

=== XML data file ===

NOTE: Where an edge is probed, the resulting probed locations will be written to an XML data file.  This file may be manually imported into a Fixture object so as to set the workpiece's rotation.  It should be noted that this feature is available *ONLY FOR EMC2* based machines.  It uses a LOGOPEN, LOG and LOGCLOSE special comment that is supported by the EMC2 application.  For other machines, the probing operations will work but the XML data will not be generated.

=== Corner and Final Coordinates ===

If a corner probing operation is being used then two optional coordinate values may be entered.  These allow the user to define the probed corner as representing a particular coordinate in the HeeksCNC design space.  The final coordinate represents where the probe's tip will end up when the probing operation is complete.  The scenario being that the only corner available for probing is the bottom right corner (due to the fixtures covering up the other corners, for example).  The bottom right corner represents a particular coordinate in the design (say 120, -100, 0).  If this value is assigned as the corner coordinate and the final coordinate is set to (0,0,0) then the probing operation will calculate where the 0,0,0 point would be if the probed point represents (120, -100, 0) and the workpiece has been rotated by some measured amount.  NOTE: that, if the workpiece's rotation is used following the probing operation, it makes sense to assign the final coordinate as (0,0,0) as all rotations occur around this point.

=== Point Data Format ===

For a grid probing operation, this parameter may be set to either 'Point Cloud' or 'Fixture Measurement'.  If 'Point Cloud' is selected, the 'Num points along X' and 'Num points along Y' parameters will be available.  If the 'Fixture Measurement' setting is chosen then the number of points will implicitly be three.  The first straight down from the probe's initial position and the other two at 'distance' along the X and Y axes respectively.  If the 'Fixture Measurement' option is chosen, the XML point data will include vector point coordinates for each pair of points probed.  This third vector point is used when reading back into the Fixture object to indicate what nominal direction the previous two points were expected to conform to.  Their deviation from this vector indicates the rotation.

choices.push_back ( wxString ( _("Point Cloud") ) );
	choices.push_back ( wxString ( _("Fixture Measurement") ) );
	list->push_back ( new PropertyChoice ( _("Point Data Format"),  choices, (m_for_fixture_measurement?1:0), this, on_set_reason ) );
